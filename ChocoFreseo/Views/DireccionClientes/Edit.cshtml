@model ChocoFreseo.Models.Domain.DireccionCliente

@{
    ViewData["Title"] = "Editar dirección";
}

<div class="row">
    <div class="col-12 col-lg-6 mb-3">
        <div class="card">
            <div class="card-body">
                <h2 class="mb-1">Editar dirección</h2>
                <p class="text-muted mb-3">
                    Actualiza la información de la dirección del cliente.
                </p>

                <form asp-action="Edit" method="post">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-2"></div>

                    <input type="hidden" asp-for="Id" />

                    <div class="mb-3">
                        <label asp-for="ClienteId" class="form-label">Cliente</label>
                        <select asp-for="ClienteId" class="form-select" asp-items="ViewBag.ClienteId">
                            <option value="">-- Selecciona un cliente --</option>
                        </select>
                        <span asp-validation-for="ClienteId" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Barrio" class="form-label">Barrio</label>
                        <input asp-for="Barrio" class="form-control" />
                        <span asp-validation-for="Barrio" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Calle" class="form-label">Calle / Vía</label>
                        <input asp-for="Calle" class="form-control" />
                        <span asp-validation-for="Calle" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Numero" class="form-label">Número</label>
                        <input asp-for="Numero" class="form-control" />
                        <span asp-validation-for="Numero" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Referencia" class="form-label">Referencia adicional</label>
                        <textarea asp-for="Referencia" class="form-control" rows="2"></textarea>
                        <span asp-validation-for="Referencia" class="text-danger"></span>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" asp-for="EsPrincipal" />
                        <label class="form-check-label" asp-for="EsPrincipal">
                            Usar como dirección principal del cliente
                        </label>
                    </div>

                    <input type="hidden" asp-for="Latitud" id="Latitud" />
                    <input type="hidden" asp-for="Longitud" id="Longitud" />

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            Guardar cambios
                        </button>
                        <a asp-action="Index" class="btn btn-secondary">
                            Volver al listado
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Mapa -->
    <div class="col-12 col-lg-6 mb-3">
        <div class="card">
            <div class="card-body">
                <h5 class="mb-2">Ubicación en el mapa</h5>
                <p class="text-muted mb-2">
                    Puedes ajustar la ubicación haciendo clic en el mapa.
                </p>
                <div id="map-direccion" style="height: 360px; border-radius: 10px; border: 2px solid #E53935;"></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        var defaultLat = 3.4516;
        var defaultLng = -76.5320;

        var modelLat = @((Model?.Latitud ?? 0).ToString(System.Globalization.CultureInfo.InvariantCulture));
        var modelLng = @((Model?.Longitud ?? 0).ToString(System.Globalization.CultureInfo.InvariantCulture));

        var lat = modelLat != 0 ? modelLat : defaultLat;
        var lng = modelLng != 0 ? modelLng : defaultLng;

        var map = L.map('map-direccion').setView([lat, lng], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        var marker = null;

        function setMarkerAndInputs(latlng) {
            if (marker) {
                marker.setLatLng(latlng);
            } else {
                marker = L.marker(latlng).addTo(map);
            }

            document.getElementById("Latitud").value = latlng.lat.toString().replace(',', '.');
            document.getElementById("Longitud").value = latlng.lng.toString().replace(',', '.');
        }

        map.on('click', function (e) {
            setMarkerAndInputs(e.latlng);
        });

        if (modelLat != 0 && modelLng != 0) {
            setMarkerAndInputs({ lat: modelLat, lng: modelLng });
        }
    </script>
}
